<?xml version="1.0" encoding="UTF-8"?>
<!--Sample XML file generated by XML Spy v4.3 U (http://www.xmlspy.com)-->
<mtbsd:serviceDefinition
xmlns:mtbsd="http://pisa.intecs.it/mass/toolbox/serviceDefinition" xmlns="http://pisa.intecs.it/mass/toolbox/xmlScript">
	<mtbsd:operation name="Order">
		<mtbsd:send>
			<sequence>
			   <dumpFile>
			        <stringCat>
                                   <string>/home/toolbox/TestEnvironment/InputDir/Order_req_</string>
				   <orderId/>
				   <string>.txt</string>
				</stringCat>
				<xslt xmlOutput="false">
				   <xmlRequest/>
				   <string>/home/toolbox/TestEnvironment/TS_02/TS_02_02/S10.xsl</string>
				</xslt>
			   </dumpFile>			  
			</sequence>
		</mtbsd:send>
		<mtbsd:check>
		   <sequence>		         
			<setVariable name="filenameXML">
			    <stringCat>
                                   <string>/home/toolbox/TestEnvironment/OutputDir/Order_res_</string>
				   <orderId/>
				   <string>.xml</string>
			    </stringCat>
			</setVariable>
			<log>
			    <stringCat>
                                <string>Check File Name XML: </string>
				<variable name="filenameXML"/>
			    </stringCat>
			</log>
			
			<if>
			    <fileExists>
			        <variable name="filenameXML"/>
			    </fileExists>
			    <literal type="boolean" value="true"/>
			    <literal type="boolean" value="false"/>
			</if>
	           </sequence>
		</mtbsd:check>
		<mtbsd:get>
		    <sequence>		       
			<setVariable name="filenameXML">
			    <stringCat>
                                   <string>/home/toolbox/TestEnvironment/OutputDir/Order_res_</string>
				   <orderId/>
				   <string>.xml</string>
			    </stringCat>
			</setVariable>					
			<setVariable name="text">
			    <setText>
			         <loadFile>
			              <variable name="filenameXML"/>
			         </loadFile>
			     </setText>
			</setVariable>
			<setVariable name="userName">
			    <sequence>
			        <variable name="text"/>
				<gotoLineStart/>
			        <horizontalMove>
			             <literal value="10"/>				
			        </horizontalMove>				 
			        <mark name="fStart"/>
			        <gotoLineEnd/>
			        <mark name="fEnd"/>
			        <extract start="fStart" end="fEnd"/>
			     </sequence>   
			 </setVariable>			
			 <setVariable name="timeOfService">
			     <sequence>				     
			          <variable name="text"/>
				  <gotoLineStart/>
				  <verticalMove/>
				  <fieldMove separators=":\b"/>		              
			          <mark name="fStart"/>
			          <gotoLineEnd/>
			          <mark name="fEnd"/>
			          <extract start="fStart" end="fEnd"/>
			      </sequence> 
			  </setVariable>
			  <setVariable name="productName">
		              <sequence>				     
			          <variable name="text"/>
				  <gotoLineStart/>
				  <verticalMove/>
				  <fieldMove separators=":\b"/>		              
			          <mark name="fStart"/>
			          <gotoLineEnd/>
			          <mark name="fEnd"/>
			          <extract start="fStart" end="fEnd"/>
			      </sequence>
			  </setVariable>
			  <setVariable name="productSize">
		              <sequence>     
			          <variable name="text"/>
				  <gotoLineStart/>
				  <verticalMove/>
				  <fieldMove separators=":\b"/>		              
			          <mark name="fStart"/>
			          <gotoLineEnd/>
			          <mark name="fEnd"/>
			          <extract start="fStart" end="fEnd"/>
			      </sequence>
			  </setVariable>		  			      
			  <setVariable name="orderId">
			      <orderId/>
			  </setVariable>	   
			  <setVariable name="massHost">
			      <massHost/>
			  </setVariable>
			  <setVariable name="userAccount">
			      <stringCat>
			          <variable name="userName"/>
				  <randomString length="3"/>
			      </stringCat>
			  </setVariable>
			  <setVariable name="password">			     
			      <randomString length="8"/>			      
			  </setVariable>
			  <log>
			      <stringCat>
			          <string>Password: </string>
			          <variable name="password"/>  
			      </stringCat>
			  </log>
			  <setVariable name="pathUserDir">			     
			      <stringCat>
			          <string>/home/toolbox/TestEnvironment/Data/</string>
			          <variable name="userName"/>
			      </stringCat>	      
			  </setVariable>
			  <log>
			      <stringCat>
			          <string>pathUserDir: </string>
			          <variable name="pathUserDir"/>  
			      </stringCat>
			  </log>
			  <methodInvocation methodName="mkdirs">
			      <object>
			        <newObject>
				  <classLiteral class="java.io.File"/>
			          <parameter>
				    <classLiteral class="java.lang.String"/>
				    <variable name="pathUserDir"/>
	                          </parameter>
		                </newObject>
		              </object>
	 	        </methodInvocation>	
			<setVariable name="userQuota">
			    <literal value="2548"/>
			</setVariable>
			<log>
			      <stringCat>
			          <string>USER QUOTA:  </string>
			          <variable name="userQuota"/>  
			      </stringCat>
			  </log>
			<setVariable name="maxUserQuota">			     
			   <multiply>
			       <literal value="10"/>
			       <literal value="1024"/>
			       <literal value="1024"/>
			   </multiply>
			</setVariable>
			<setVariable name="usedQuota">
			   <itoa>	     
			      <plus>
			          <atoi><variable name="userQuota"/></atoi>
			          <atoi><variable name="productSize"/></atoi>
			      </plus>
			   </itoa>
			</setVariable>
			<setVariable name="availableQuota">
			   <itoa>	     
			      <minus>
			          <atoi><variable name="maxUserQuota"/></atoi>
			          <atoi><variable name="usedQuota"/></atoi>
			      </minus>
			   </itoa>  
			</setVariable>
			<setVariable name="orderResultURL">
			   <stringCat>		   			          
			          <variable name="pathUserDir"/>
			   </stringCat>
			</setVariable>
			<mkdir>			  	   			          
			   <variable name="orderResultURL"/>				  
			</mkdir>
			<setVariable name="outputDir">
			   <string>/home/toolbox/TestEnvironment/Data/Images/</string>
			</setVariable>
			<setVariable name="linkFile">
			  <stringCat>		   			          
			       <variable name="orderResultURL"/>
			       <string>/</string>
			       <variable name="productName"/>
			       <string>.ZIP</string>  
			   </stringCat>
			</setVariable>
			<setVariable name="commandString">
			   <stringCat>
			       <string>ln -s </string>
			       <variable name="outputDir"/>
			       <variable name="productName"/>
			       <string>.ZIP </string>
			       <variable name="linkFile"/>
			   </stringCat>
			</setVariable>			
			<command>
			    <variable name="commandString"/>		   
			</command>
			<ftpAccount duration="5m">
			   <user><variable name="userAccount"/></user>
			   <password><variable name="password"/></password>
			   <rootDir>
			      <variable name="orderResultURL"/>
	                   </rootDir>
		        </ftpAccount>
			<log>
			    <stringCat>
                                <string>orderResultURL: </string>
				<variable name="orderResultURL"/>
			    </stringCat>
			</log>
			<log>
			    <stringCat>
                                <string>Link: </string>
				<variable name="linkFile"/>
			    </stringCat>
			</log>
			<timer delay="5m">
			   <sequence>				           
			      <fileDelete>
			         <variable name="linkFile"/>
			      </fileDelete>
			      <rmdir>
			         <variable name="orderResultURL"/>
			      </rmdir>
			   </sequence>
			</timer>
			<xml attributePrefix="attribute$" textTag="evaluate">	
		            <mass:getOrderResultOutputMsg xmlns:mass="http://www.esa.int/mass">
				<mass:commonInput>
				    <mass:orderId><evaluate name="orderId"/></mass:orderId>
				    <mass:isSubscription>0</mass:isSubscription>
				    <mass:massHostAddress><evaluate name="massHost"/></mass:massHostAddress>
			        </mass:commonInput>
				<mass:getOrderOutput>
				    <mass:statusInfo>
				        <mass:statusId>0</mass:statusId>
				        <mass:statusMsg>Successful</mass:statusMsg>
				    </mass:statusInfo>
				    <mass:orderResultURL>ftp://toolboxHostName:2121</mass:orderResultURL>
				    <mass:userName><evaluate name="userAccount"/></mass:userName>
				    <mass:password><evaluate name="password"/></mass:password>
				    <mass:timePeriodOfService><evaluate name="timeOfService"/></mass:timePeriodOfService>
				    <mass:productSize><evaluate name="productSize"/></mass:productSize>    
				    <mass:userQuota><evaluate name="availableQuota"/></mass:userQuota>
				</mass:getOrderOutput>
		           </mass:getOrderResultOutputMsg>
		       </xml>
		    </sequence>
		</mtbsd:get>
	</mtbsd:operation>
</mtbsd:serviceDefinition>




