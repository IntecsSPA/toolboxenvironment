<?xml version="1.0" encoding="UTF-8"?>
<fork>
    <sequence>
        <setVariable name="currentPercentage">
            <string>0</string>
        </setVariable><!-- Output Control -->
        <setVariable name="outputControlScript">
            <xslt xmlOutput="true">
                <variable name="processRequest"/>
                <path startFrom="SERVICE_RESOURCE_DIR">
                    <string>../AdditionalResources/WPS/XSL/ExecuteOutputControl.xsl</string>
                </path>
                <parameter name="outputRepository">
                    <variable name="wpsOutputFolder"/>
                </parameter>
            </xslt>
        </setVariable>
        <dumpXML>
            <string>${wpsScriptFolder}outputControlScript.tscript</string>
            <variable name="outputControlScript"/>
        </dumpXML>
        <loadProcedure name="OutputControlProcedure">
            <string>${wpsScriptFolder}outputControlScript.tscript</string>
        </loadProcedure>
        <call procedure="OutputControlProcedure">
            <argument name="outputsControl">
                <string/>
            </argument>
            <argument name="outputsException">
                <string/>
            </argument>
            <argument name="outputsExceptionMessage">
                <string/>
            </argument>
        </call><!-- End Output Control-->
        <while>
            <and>
                <oneq>
                    <variable name="currentPercentage"/>
                    <string>100</string>
                </oneq>
                <oeq>
                    <variable name="outputsControl"/>
                    <string>ProcessPending</string>
                </oeq>
            </and>
            <sequence>
                <log>
                    <stringCat>
                        <string>Current Percentage: </string>
                        <variable name="currentPercentage"/>
                    </stringCat>
                </log>
                <if>
                    <fileExists>
                        <variable name="wpsStatusPercentageFile"/>
                    </fileExists>
                    <sequence>
                        <setVariable name="newPercentage">
                            <xPath>
                                <loadXML>
                                    <variable name="wpsStatusPercentageFile"/>
                                </loadXML>
                                <string>Percentage/@value</string>
                            </xPath>
                        </setVariable>
                        <if>
                            <oneq>
                                <variable name="newPercentage"/>
                                <variable name="currentPercentage"/>
                            </oneq>
                            <sequence>
                                <setVariable name="currentPercentage">
                                    <variable name="newPercentage"/>
                                </setVariable>
                                <setVariable name="statusExecuteResponse"><!-- Generate Execute Response -->
                                    <xslt xmlOutput="true">
                                        <variable name="processRequest"/>
                                        <path startFrom="SERVICE_RESOURCE_DIR">
                                            <string>../AdditionalResources/WPS/XSL/GenerateExecuteResponse.xsl</string>
                                        </path>
                                        <parameter name="processName">
                                            <variable name="executeProcessName"/>
                                        </parameter>
                                        <parameter name="status">
                                            <string>ProcessStarted</string>
                                        </parameter>
                                        <parameter name="statusMessage">
                                            <string/>
                                        </parameter>
                                        <parameter name="statusLocation">
                                            <variable name="statusLocationVariable"/>
                                        </parameter>
                                        <parameter name="creationTime">
                                            <dateStringFormatter format="yyyy-MM-dd'T'HH:mm:ss'Z'">
                                                <now/>
                                            </dateStringFormatter>
                                        </parameter>
                                        <parameter name="outputHttpRequest">
                                            <variable name="toolboxGetServiceResourceURL"/>
                                        </parameter>
                                        <parameter name="particularReferenceID">
                                            <variable name="particularReferenceIdentifier"/>
                                        </parameter>
                                        <parameter name="particularReferenceURL">
                                            <variable name="particularReferenceURL"/>
                                        </parameter>
                                        <parameter name="outputFolder">
                                            <variable name="wpsOutputFolder"/>
                                        </parameter>
                                        <parameter name="statusPercentCompleted">
                                            <variable name="currentPercentage"/>
                                        </parameter><!--parameter name="originalRequest"><xmlRequest/></parameter-->
                                    </xslt><!-- End Response-->
                                </setVariable>
                                <dumpXML>
                                    <string>${wpsStatusFolder}executeResponseStatus.xml</string>
                                    <variable name="statusExecuteResponse"/>
                                </dumpXML>
                            </sequence>
                        </if>
                    </sequence>
                </if>
                <loadProcedure name="OutputControlProcedure">
                    <string>${wpsScriptFolder}outputControlScript.tscript</string>
                </loadProcedure>
                <call procedure="OutputControlProcedure">
                    <argument name="outputsControl">
                        <string/>
                    </argument>
                    <argument name="outputsException">
                        <string/>
                    </argument>
                    <argument name="outputsExceptionMessage">
                        <string/>
                    </argument>
                </call><!-- End Output Control-->
                <if>
                    <oneq>
                        <variable name="outputsControl"/>
                        <string>ProcessPending</string>
                    </oneq>
                    <sequence>
                        <setVariable name="statusExecuteResponse"><!-- Generate Execute Response -->
                            <xslt xmlOutput="true">
                                <variable name="processRequest"/>
                                <path startFrom="SERVICE_RESOURCE_DIR">
                                    <string>../AdditionalResources/WPS/XSL/GenerateExecuteResponse.xsl</string>
                                </path>
                                <parameter name="processName">
                                    <variable name="executeProcessName"/>
                                </parameter>
                                <parameter name="status">
                                    <variable name="outputsControl"/>
                                </parameter>
                                <parameter name="statusMessage">
                                    <string/>
                                </parameter>
                                <parameter name="statusLocation">
                                    <variable name="statusLocationVariable"/>
                                </parameter>
                                <parameter name="creationTime">
                                    <dateStringFormatter format="yyyy-MM-dd'T'HH:mm:ss'Z'">
                                        <now/>
                                    </dateStringFormatter>
                                </parameter>
                                <parameter name="outputHttpRequest">
                                    <variable name="toolboxGetServiceResourceURL"/>
                                </parameter>
                                <parameter name="particularReferenceID">
                                    <variable name="particularReferenceIdentifier"/>
                                </parameter>
                                <parameter name="particularReferenceURL">
                                    <variable name="particularReferenceURL"/>
                                </parameter>
                                <parameter name="outputFolder">
                                    <variable name="wpsOutputFolder"/>
                                </parameter>
                                <parameter name="statusExceptionCode">
                                    <variable name="outputsException"/>
                                </parameter>
                                <parameter name="statusMessage">
                                    <variable name="outputsExceptionMessage"/>
                                </parameter><!--parameter name="originalRequest"><xmlRequest/></parameter-->
                            </xslt><!-- End Response-->
                        </setVariable>
                        <dumpXML>
                            <string>${wpsStatusFolder}executeResponseStatus.xml</string>
                            <variable name="statusExecuteResponse"/>
                        </dumpXML>
                    </sequence>
                </if>
                <sleep amount="{$sleepStatus}"/>
            </sequence>
        </while>
    </sequence>
</fork>